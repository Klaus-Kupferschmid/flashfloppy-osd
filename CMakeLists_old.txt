cmake_minimum_required(VERSION 3.15)

# Project name and version
set(PROJECT_NAME FF_OSD)
set(FW_VER "1.9")

# Toolchain configuration
set(CMAKE_SYSTEM_NAME Generic)
set(CMAKE_SYSTEM_VERSION 1)
set(CMAKE_SYSTEM_PROCESSOR arm)

# Cross-compilation toolchain
set(CMAKE_C_COMPILER arm-none-eabi-gcc)
set(CMAKE_CXX_COMPILER arm-none-eabi-g++)
set(CMAKE_ASM_COMPILER arm-none-eabi-gcc)
set(CMAKE_AR arm-none-eabi-ar)
set(CMAKE_OBJCOPY arm-none-eabi-objcopy)
set(CMAKE_OBJDUMP arm-none-eabi-objdump)
set(CMAKE_SIZE arm-none-eabi-size)
set(CMAKE_DEBUGGER arm-none-eabi-gdb)

# Prevent CMake from testing the compiler
set(CMAKE_C_COMPILER_FORCED TRUE)
set(CMAKE_CXX_COMPILER_FORCED TRUE)
set(CMAKE_ASM_COMPILER_FORCED TRUE)

# Project definition
project(${PROJECT_NAME} C ASM)

# Build type
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release)
endif()

# STM32 target selection - can be overridden from command line
if(NOT DEFINED STM32_TARGET)
    set(STM32_TARGET "F103CBT6" CACHE STRING "STM32 Target (F103C8T6 or F103CBT6)")
endif()

# MCU configuration based on target
if(STM32_TARGET STREQUAL "F103C8T6")
    set(MCU_FLASH_SIZE 64K)
    set(MCU_RAM_SIZE 20K)
    set(MCU_LINKER_SCRIPT "stm32f103c8t6.ld")
    message(STATUS "Building for STM32F103C8T6 (64KB Flash, 20KB RAM)")
elseif(STM32_TARGET STREQUAL "F103CBT6")
    set(MCU_FLASH_SIZE 128K)
    set(MCU_RAM_SIZE 20K)
    set(MCU_LINKER_SCRIPT "stm32f103cbt6.ld")
    message(STATUS "Building for STM32F103CBT6 (128KB Flash, 20KB RAM)")
else()
    message(FATAL_ERROR "Unsupported STM32_TARGET: ${STM32_TARGET}. Use F103C8T6 or F103CBT6")
endif()

# Compiler flags
set(MCU_FLAGS "-mcpu=cortex-m3 -mthumb -mfloat-abi=soft")
set(COMMON_FLAGS "${MCU_FLAGS} -Wall -Werror -Wno-format -Wdeclaration-after-statement")
set(COMMON_FLAGS "${COMMON_FLAGS} -Wstrict-prototypes -Wredundant-decls -Wnested-externs")
set(COMMON_FLAGS "${COMMON_FLAGS} -fno-common -fno-exceptions -fno-strict-aliasing")
set(COMMON_FLAGS "${COMMON_FLAGS} -mlittle-endian -std=gnu99")

# Debug vs Release flags
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    set(CMAKE_C_FLAGS "${COMMON_FLAGS} -g -Og")
    set(CMAKE_ASM_FLAGS "${COMMON_FLAGS} -g -Og")
else()
    set(CMAKE_C_FLAGS "${COMMON_FLAGS} -g -Os -DNDEBUG")
    set(CMAKE_ASM_FLAGS "${COMMON_FLAGS} -g -Os -DNDEBUG")
endif()

# Linker flags
set(CMAKE_EXE_LINKER_FLAGS "${MCU_FLAGS} -nostdlib -Wl,--gc-sections")
set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -T${CMAKE_SOURCE_DIR}/linker/${MCU_LINKER_SCRIPT}")

# Include directories
include_directories(
    ${CMAKE_SOURCE_DIR}/inc
)

# Source files
set(SOURCES
    src/amiga.c
    src/build_info.c
    src/cancellation.c
    src/config.c
    src/console.c
    src/i2c.c
    src/main.c
    src/string.c
    src/stm32f10x.c
    src/time.c
    src/timer.c
    src/util.c
    src/vectors.S
)

# Generate linker script from template
configure_file(
    ${CMAKE_SOURCE_DIR}/src/FF_OSD.ld.S
    ${CMAKE_BINARY_DIR}/FF_OSD.ld
    @ONLY
)

# Preprocess linker script
add_custom_command(
    OUTPUT ${CMAKE_BINARY_DIR}/linker/${MCU_LINKER_SCRIPT}
    COMMAND ${CMAKE_COMMAND} -E make_directory ${CMAKE_BINARY_DIR}/linker
    COMMAND ${CMAKE_C_COMPILER} -P -E -x c 
            -DFLASH_SIZE=${MCU_FLASH_SIZE} -DRAM_SIZE=${MCU_RAM_SIZE}
            ${CMAKE_SOURCE_DIR}/src/FF_OSD.ld.S 
            -o ${CMAKE_BINARY_DIR}/linker/${MCU_LINKER_SCRIPT}
    DEPENDS ${CMAKE_SOURCE_DIR}/src/FF_OSD.ld.S
    COMMENT "Generating linker script for ${STM32_TARGET}"
)

# Create linker script target
add_custom_target(linker_script 
    DEPENDS ${CMAKE_BINARY_DIR}/linker/${MCU_LINKER_SCRIPT}
)

# Create executable
add_executable(${PROJECT_NAME}.elf ${SOURCES})

# Add dependency on linker script
add_dependencies(${PROJECT_NAME}.elf linker_script)

# Compiler definitions
target_compile_definitions(${PROJECT_NAME}.elf PRIVATE
    FW_VER="${FW_VER}"
    STM32F10X_MD
    USE_STDPERIPH_DRIVER
    ${STM32_TARGET}
)

# Special compilation flags for specific files
set_source_files_properties(src/build_info.c PROPERTIES 
    COMPILE_FLAGS "-DFW_VER=\"\\\"${FW_VER}\\\"\""
)

set_source_files_properties(src/util.c PROPERTIES 
    COMPILE_FLAGS "-fno-tree-loop-distribute-patterns"
)

# Create HEX file
add_custom_command(TARGET ${PROJECT_NAME}.elf POST_BUILD
    COMMAND ${CMAKE_OBJCOPY} -O ihex $<TARGET_FILE:${PROJECT_NAME}.elf> ${PROJECT_NAME}-v${FW_VER}-${STM32_TARGET}.hex
    COMMENT "Creating HEX file"
)

# Create BIN file
add_custom_command(TARGET ${PROJECT_NAME}.elf POST_BUILD
    COMMAND ${CMAKE_OBJCOPY} -O binary $<TARGET_FILE:${PROJECT_NAME}.elf> ${PROJECT_NAME}-v${FW_VER}-${STM32_TARGET}.bin
    COMMENT "Creating BIN file"
)

# Show memory usage
add_custom_command(TARGET ${PROJECT_NAME}.elf POST_BUILD
    COMMAND ${CMAKE_SIZE} --format=berkeley $<TARGET_FILE:${PROJECT_NAME}.elf>
    COMMENT "Memory usage:"
)

# Custom targets for different MCU variants
add_custom_target(build_f103c8t6
    COMMAND ${CMAKE_COMMAND} -DSTM32_TARGET=F103C8T6 -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} 
            --build ${CMAKE_BINARY_DIR} --target ${PROJECT_NAME}.elf
    COMMENT "Building for STM32F103C8T6"
)

add_custom_target(build_f103cbt6
    COMMAND ${CMAKE_COMMAND} -DSTM32_TARGET=F103CBT6 -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
            --build ${CMAKE_BINARY_DIR} --target ${PROJECT_NAME}.elf
    COMMENT "Building for STM32F103CBT6"
)

# Flash target (requires st-flash from stlink tools)
add_custom_target(flash
    COMMAND st-flash write ${PROJECT_NAME}-v${FW_VER}-${STM32_TARGET}.bin 0x8000000
    DEPENDS ${PROJECT_NAME}.elf
    COMMENT "Flashing ${PROJECT_NAME}-v${FW_VER}-${STM32_TARGET}.bin to ${STM32_TARGET}"
)

# Clean additional files
set_property(DIRECTORY PROPERTY ADDITIONAL_MAKE_CLEAN_FILES
    "${PROJECT_NAME}-v${FW_VER}-${STM32_TARGET}.hex"
    "${PROJECT_NAME}-v${FW_VER}-${STM32_TARGET}.bin"
    "${CMAKE_BINARY_DIR}/linker"
)

# Print build configuration
message(STATUS "Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "Target MCU: ${STM32_TARGET}")
message(STATUS "Flash size: ${MCU_FLASH_SIZE}")
message(STATUS "RAM size: ${MCU_RAM_SIZE}")